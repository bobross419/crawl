###############################################################################
# Octopus King Sprint
#
# General comments:
# - Needs to be playable by any combo
# - Can portals trigger storyline messages?
# - 8 Rings, autogenerated with _make_octoring(() yay
# - 1 Octopus Trident
# - Each Branch has one Item and a Boss
#    * Bosses should be royalty whenever possible
# - Branches:
#  **DESC for each vault/
#   - 5 Dungeon (Water everywhere, get shallower as progress)
#   - 1 Orc (Trident)
#   - 2 Shoals
#   - 2 Snake (retired snake queen lamia)
#   - 2 Vault
#   - 1 Crypt 
#   - 1 Wizlab ( A few wizardy uniques studying together )
#   - 1 Crypt 
#   - 2 Hell (Pick 1 @ Random)
#          SUBST: ? : TUV
#             replaces occurrences of ? with one of TUV, and guarantees that all
#             occurrences of ? will get the same replacement symbol.
#   - 2 Pan (Pick 2 Pan Lords @ Random)
#   - 2 Holy
#   - 1 OctoRealm
#     - New Unique: Octo Prince Regal the Pretender: Hopes orb will help legitimacy
#       - Spawns with 1 piece of OctoKing Kit 
#       - Has a Killer Klown (Fool) and Corn Cob guy (Cob) with him in sprint
#       - Spell - Charm: Can charm player allies
#             TODO: Submit PR so Charm can work against player allies
#                     orc->del_ench(ENCH_CHARM); 
#                     mons_pacify(*orc, ATT_GOOD_NEUTRAL, true); 
#                     if (mon->attitude != ATT_HOSTILE)  
#                      mon->del_ench(ENCH_CHARM);   
#   
#                     gozag_break_bribe(mon);
#                     mons_att_changed(mon);
#   
#  Some things to think about for your next steps:
#  
#  Where do we want these enemies to appear? Are we trying to balance them to be late-game threats, or to be somewhere in Extended? (This will affect the stat choices - the current stats might be appropriate for late-game, but will be quite weak in Pan, etc.)
#  What will the feeling of this fight be? How will different characters prioritize different members of the party?
#  How do we incentivize players to fight these uniques? The correct response to a dangerous encounter is, generally, to run away. Making players engage with uniques requires either a carrot (cool loot - XP won't be enough, late game), a stick (fast move speed, immobilizing hexes, ...) or both.
#  What's a fun theme for these characters that fits into the Crawl world? Since they're your addition, I want to let you take the lead on this, but I'm very happy to make suggestions if you prefer. 
#  #   
#   
#   LUA Prompts: https://github.com/crawl/crawl/blob/master/crawl-ref/docs/develop/levels/advanced.txt#L705
#
# Natural Ability: Radiant Charm
#     Roll charm against every hostile in direct LoS (opacity_no_trans)
#                 vector<coord_def> find_recite_targets()  
#                 static bool _set_hex_target(monster* caster, bolt& pbolt) # has logic to go through all target
#                  * Build a function that sets up a fake beam for targeting special spells.
#                 static function<void(bolt&, const monster&, int)> _target_beam_setup(function<coord_def(const monster&)> targeter) 
#                 _los_spell_worthwhile(caster, SPELL_DRAIN_LIFE) 
#                 
#                 
#     It should mass reflect charm if it is bounced off the warlock's mirror, so fucking cool 
#                 
###############################################################################
{{
function tableHasKey(table,key)
    return table[key] ~= nil
end
}}

NAME:   octopus_king
DESC:   Sprint X: "The Return of the Octopus King"
ORDER:  10
TAGS:   sprint no_item_gen no_trap_gen no_pool_fixup no_rotate no_hmirror no_vmirror
ORIENT: encompass
SUBVAULT: E : sprint_king_entry
SUBVAULT: T : sprint_king_temple
SUBVAULT: D : sprint_king_dungeon
SUBVAULT: O : sprint_king_orc
SUBVAULT: A : sprint_king_shoals
SUBVAULT: P : sprint_king_snake
SUBVAULT: V : sprint_king_vault
SUBVAULT: C : sprint_king_crypt_entry
SUBVAULT: J : sprint_king_crypt_exit
SUBVAULT: W : sprint_king_wizlab
SUBVAULT: H : sprint_king_hell
SUBVAULT: L : sprint_king_holy
SUBVAULT: R : sprint_king_octorealm


MAP
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
XEEEEEEEEEEEEEEEEETTTTTTTTTTTTTTDDDDDDDDDDDDDDDDDDDDDDDX
XEEEEEEEEEEEEEEEEETTTTTTTTTTTTTTDDDDDDDDDDDDDDDDDDDDDDDX
XEEEEEEEEEEEEEEEEETTTTTTTTTTTTTTDDDDDDDDDDDDDDDDDDDDDDDX
XEEEEEEEEEEEEEEEEETTTTTTTTTTTTTTDDDDDDDDDDDDDDDDDDDDDDDX
XEEEEEEEEEEEEEEEEETTTTTTTTTTTTTTDDDDDDDDDDDDDDDDDDDDDDDX
XEEEEEEEEEEEEEEEEETTTTTTTTTTTTTTDDDDDDDDDDDDDDDDDDDDDDDX
XEEEEEEEEEEEEEEEEETTTTTTTTTTTTTTDDDDDDDDDDDDDDDDDDDDDDDX
XVVVVVVVVVVVVVVVVVPPPPPPPPPPPPPPAAAAAAAAAAAOOOOOOOOOOOOX
XVVVVVVVVVVVVVVVVVPPPPPPPPPPPPPPAAAAAAAAAAAOOOOOOOOOOOOX
XVVVVVVVVVVVVVVVVVPPPPPPPPPPPPPPAAAAAAAAAAAOOOOOOOOOOOOX
XVVVVVVVVVVVVVVVVVPPPPPPPPPPPPPPAAAAAAAAAAAOOOOOOOOOOOOX
XVVVVVVVVVVVVVVVVVPPPPPPPPPPPPPPAAAAAAAAAAAOOOOOOOOOOOOX
XVVVVVVVVVVVVVVVVVPPPPPPPPPPPPPPAAAAAAAAAAAOOOOOOOOOOOOX
XVVVVVVVVVVVVVVVVVPPPPPPPPPPPPPPAAAAAAAAAAAOOOOOOOOOOOOXX
XCCCCCCWWWWWJJJJJJHHHHHHHHHHHHHHLLLLLLRRRRRRRRRRRRRRRRRRX
XCCCCCCWWWWWJJJJJJHHHHHHHHHHHHHHLLLLLLRRRRRRRRRRRRRRRRRRX
XCCCCCCWWWWWJJJJJJHHHHHHHHHHHHHHLLLLLLRRRRRRRRRRRRRRRRRRX
XCCCCCCWWWWWJJJJJJHHHHHHHHHHHHHHLLLLLLRRRRRRRRRRRRRRRRRRX
XCCCCCCWWWWWJJJJJJHHHHHHHHHHHHHHLLLLLLRRRRRRRRRRRRRRRRRRX
XCCCCCCWWWWWJJJJJJHHHHHHHHHHHHHHLLLLLLRRRRRRRRRRRRRRRRRRX
XCCCCCCWWWWWJJJJJJHHHHHHHHHHHHHHLLLLLLRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXRRRRRRRRRRRRRRRRRRX
XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
ENDMAP

NAME: sprint_king_entry
TAGS: sprint_king_entry no_rotate no_hmirror no_vmirror ruin
KMONS: 1 =  frilled lizard /  rat
KMONS: 2 =  giant cockroach /  ball python
KMONS: K =  kobold ; q:3 dart ego:poisoned | q:3 dart ego:atropa | dart q:3 ego:curare
KMONS: W = plant w:5 / nothing
KFEAT: 1WD = shallow_water
KFEAT: R = rock_wall
KMONS: ZD = plant
KITEM: 1 = stone q:4 / stone q:3
KITEM: Z = trident_of_the_octopus_king ident:all
KITEM: D = wand of digging charges:1
KITEM: Y = potion of flight ident:all q:1 / scroll of blinking q:1
KFEAT: 2 = shallow_water / floor w:5
KFEAT: 3 = shallow_water / deep_water
KFEAT: 4 = floor / shallow_water w:5

MAP
{wDwWWWcWK44K44K4
WwwWwwwcWw44C4444
wWWwWwwcWww444www
WwwwwWZcW3wwwww33
cRccccccW22222233
1wxwx.WxW22222233
WWW1wwx1W33333Y33
ENDMAP


NAME: sprint_king_temple
TAGS: sprint_king_temple no_rotate no_hmirror no_vmirror ruin
# No Ashenzari.
KITEM: e = any potion ident:all
KITEM: o = any armour
KITEM: t = any weapon
KITEM: g = any scroll ident:all
KITEM: n = any jewellery
SUBST: ? = eotgn
KITEM: N = any misc
{{ 
  local background = {
    ["Air Elementalist"] = "Air Magic",
    ["Cinder Acolyte"] = "Fire Magic",
    Conjurer = "Conjuration",
    ["Earth Elementalist"] = "Earth Magic",
    Enchanter = "Hexes",
    ["Fire Elementalist"] = "Fire Magic",
    Hexslinger = "Hexes",
    ["Ice Elementalist"] = "Ice Magic",
    Necromancer = "Necromancy",
    Reaver = "Conjuration",
    Summoner = "Summoning",
    Transmuter = "Transmutations",
    ["Venom Mage"] = "Poison Magic",
    Warper = "Translocations"
  }
  local book = ''
  if tableHasKey(background, you.class()) then
    book = "randbook numspells:5 owner:player disc:" .. background[you.class()]
  elseif you.class() == "Hedge Wizard" then
    book = "randbook numspells:8 owner:player"
  else
    book = "randbook numspells:8 owner:player slevels:12"
  end
  kitem("B = " .. book )
}}
    
KFEAT: _ = altar_ecumenical
KMONS: 1 = place:D:6 zombie / orc zombie / ogre zombie / menkaure
KMONS: 2 = place:D:6 skeleton / kobold skeleton / gnoll skeleton
SUBST: ! = 12
KFEAT: E = enter_sewer
KFEAT: b = shallow_water
COLOUR: b = lightgreen

MAP
XXX??x2_._2x??
EbXB?x.2_2.x?N
XbX??+.....+??
XbX??x1x+x1x??
XbXxxxxx.xxxxx
XbE..!....!...
XXXxxxxxxxxxxx
ENDMAP

NAME: sprint_king_dungeon
TAGS: sprint_king_dungeon no_rotate no_hmirror no_vmirror
KMONS: 1 =  goblin /  hobgoblin /  ogre w:5
KMONS: 2 =  gnoll w:20 /  gnoll sergeant w:5 /  gnoll bouda w:2
KMONS: 3 =  sigmund ; ring_of_the_octopus_king ident:all . any book
KMONS: 4 = centaur
KMONS: 5 =  boulder beetle / manticore / ugly thing / cyclops
KMONS: D = training dummy
KITEM: B = short bow / long bow / sling / arbalest / triple crossbow / hand crossbow
KITEM: s = falchion / scimitar / long sword / double sword w:2
KITEM: a = leather armour / troll leather armour w:2
KITEM: S = great sword / triple sword w:2
KITEM: A = scale mail / chain mail / plate armour
KITEM: M = any manual

MAP
X......x2sasas..x..5...
X.xx+xxx2.2.2.2.+.G.5G.
X.x....x....22..x......
X.x1111x.SASAS2.xM.....
X.x.11.xxxxxxx+xxxxx+xx
=.xD...+..44...Bx3.=...
X.xD...+.4.....Bx..x...
ENDMAP

NAME: sprint_king_orc
TAGS: sprint_king_orc no_rotate no_hmirror no_vmirror
KMONS: 1 =  orc
KMONS: 2 =  orc warrior
KMONS: 3 =  orc priest / orc wizard
KMONS: 4 = saint roka ; ring_of_the_octopus_king ident:all
KITEM: a = hand axe / war axe /broad axe 
KITEM: L = leather armour w:20 / fire dragon scales / ice dragon scales / storm dragon scales
KITEM: A = battle axe / executioner's axe
KITEM: S = plate armour w:20 / crystal plate armour w:5 / gold dragon scales w:5
KITEM: s = any magical staff
KITEM: R = robe ego:any / robe ego:resistance / robe ego:archmagi w:5

MAP
XXXXXXXXX=XX
XASAxa......
X343xL.111..
X121xa.121..
X.1.xL.121..
Xx=xxa.333.s
=.......3.sR
ENDMAP


NAME: sprint_king_shoals
TAGS: sprint_king_shoals no_rotate no_hmirror no_vmirror
KMONS: 1 =  merfolk / merfolk siren / merfolk avatar w:5
KMONS: 2 =  water nymph / harpy / sea snake / manticore / snapping turtle / alligator
KMONS: 3 =  merfolk javelineer / merfolk impaler / merfolk aquamancer
KMONS: 4 =  rupert ; ring_of_the_octopus_king ident:all
KMONS: 5 =  octopode
KITEM: Z = any misc / any book
KFEAT: 12345 = w / W
KFEAT: ?Z = w / W / floor

MAP
XXXXXXXXXXX
XZ.WW2?WW2?
X.W2?W1W?W1
=5?3??W??2W
=?1?xx2?xW?
X==3??x??2W
X4=Z?x?31?W
ENDMAP



NAME: sprint_king_snake
TAGS: sprint_king_snake no_rotate no_hmirror no_vmirror
KMONS: 1 = water moccasin, black mamba, anaconda
KMONS: 2 = black mamba w:20 / mana viper w:5 / shock serpent w:5
KMONS: 3 = naga, naga warrior w:5
KMONS: 4 = guardian serpent, nagaraja, naga mage, naga warrior
KITEM: S = any scroll
KITEM: P = any potion

MAP
XXXXXXXXXXXXXX
Xxx1Sx.2.xP.xx
Xx.3.x.x.x..2x
=..x.4.x.3.x.1
=..x.4.x.3.x.1
Xx.3.x.x.x..2x
Xxx1Sx.1.xP.xx
ENDMAP


NAME: sprint_king_vault
TAGS: sprint_king_vault no_rotate no_hmirror no_vmirror

KMONS: 1 = human, vault guard
KMONS: 2 = yaktaur
KMONS: 3 = ironbound preserver / shadow dragon / necromancer / yaktaur captain
KMONS: 4 = mara ; ring_of_the_octopus_king ident:all . scroll of acquirement ident:all
KFEAT: T = dispersal trap
SUBST: ? = %*!
NSUBST: B = 1:3 / *:.

MAP
XXXXXXXXXXXXXXXXX
.4.x.2..1..xxxxxx
...x.B.1B.Txxxxxx
xxx=..1...T+.....
???x..1...T+.....
???x.B.1B.Txxxxxx
???x.2..1..xxxxxx
ENDMAP

NAME: sprint_king_crypt_entry
TAGS: sprint_king_crypt_entry no_rotate no_hmirror no_vmirror
KMONS: 1 = necromancer
KMONS: 2 = nergalle ; ring_of_the_octopus_king ident:all
KMONS: 3 = skeletal warrior / ghoul / guardian mummy / w:3 lich / w:3 vampire knight
KITEM: 3 = % / w:5 * / w:2 |

MAP
XXXX=X
xx...x
3+..xx
xx1.+3
2=..xx
xx.3+3
3+..xx
ENDMAP


NAME: sprint_king_wizlab
TAGS: sprint_king_wizlab no_rotate no_hmirror no_vmirror
KPROP:      . = w:1 bloody / w:15 nothing
KPROP:      ' = bloody / w:5 nothing
KMONS: 5 = human name:sickly dbname:deformed_humanoid n_adj n_spe tile:mons_deformed_human     /\
           human name:monstrous dbname:deformed_humanoid n_adj n_spe tile:mons_deformed_human  /\
           human name:deformed dbname:deformed_humanoid n_adj n_spe tile:mons_deformed_human   /\
           human name:twisted dbname:deformed_humanoid n_adj n_spe tile:mons_deformed_human    /\
           human name:grotesque dbname:deformed_humanoid n_adj n_spe tile:mons_deformed_human  /\
           human name:hideous dbname:deformed_humanoid n_adj n_spe tile:mons_deformed_human    /\
           human name:febrile dbname:deformed_humanoid n_adj n_noc tile:mons_deformed_human
KMONS: 6 = very ugly thing
KMONS: 1 = mlioglotl
KMONS: 2 = zenata
LFLOORCOL:  magenta
FTILE: .125Yc = floor_nerves
LROCKTILE:  wall_flesh
TILE:       c = wall_flesh
TILE:       X = wall_flesh
TILE:       m = wall_transparent_flesh
TILE:       + = no_random dngn_fleshy_orifice
TILE:       = = no_random dngn_fleshy_orifice
COLOUR:     m = yellow
COLOUR:     Xc+ = lightred
COLOUR:     W = green
:           set_feature_name("shallow_water", "Viscous fluid")
:           set_feature_name("stone_wall", "sinewy wall")
:           set_feature_name("clear_rock_wall", "thin membrane")
:           set_feature_name("floor", "pulsating floor")
: lua_marker('+', props_marker {
:           door_description_noun="fleshy orifice",
:           door_berserk_verb_open="You part the %s%s",
:           door_berserk_adjective="with a squelch!",
:           door_berserk_verb_close="You squeeze the %s%s closed",
:           door_noisy_verb_open="You part the %s%s with a squelch!",
:           door_noisy_verb_close="You squeeze the %s%s closed with a squelch!",
:           door_airborne_verb_open="You reach down and part the %s%s.",
:           door_airborne_verb_close="You reach down and squeeze the %s%s closed.",
:           door_verb_open="You part the %s%s.",
:           door_verb_close="You squeeze the %s%s shut."
:           })

MAP
XXXXX
X5.2=
X5Y.c
X5.1c
Xc=cc
=..6c
Xcccc
ENDMAP



NAME: sprint_king_crypt_exit
TAGS: sprint_king_crypt_exit no_rotate no_hmirror no_vmirror
KMONS: 1 = guardian mummy / mummy priest
KMONS: 2 = jory ; ring_of_the_octopus_king ident:all
KMONS: 3 = dread lich / royal mummy w:20
KMONS: 4 = ancient champion / skeletal warrior

MAP
XXXXXX
....x2
X1x.=.
Xxx.xx
X3+.+3
Xxx1xx
X4+.+4
ENDMAP


NAME: sprint_king_hell
TAGS: sprint_king_hell no_rotate no_hmirror no_vmirror
KMONS: 1 = simulacrum
KMONS: 2 = lesser demon
KMONS: 4 = cacodemon
KMONS: 5 = ice devil / wendigo
KMONS: 6 = ice fiend
KMONS: 3 = asterion ; ring_of_the_octopus_king ident:all
MARKER: E = lua:transp_loc("holy_entry")
FTILE: .123456Emn = floor_ice

MAP
XXXXXXXXXXXXXX
X..m2m1m5X....
X.m2m1m5mX....
X.mm1m6m.=..3E
X.m1m5m.m=....
X.mm5m.m.X....
=.m.m4m4mX....
ENDMAP

NAME: sprint_king_holy
TAGS: sprint_king_holy no_rotate no_hmirror no_vmirror
KMONS: 1 = daeva / angel 
KMONS: 2 = mennas ; ring_of_the_octopus_king
KMONS: 3 = apis
KITEM: ? = sacred scourge randar / eudemon blade randart / trishula randart
KITEM: A = pearl dragon scales randart / robe randart
KFEAT: Z = altar_zin
KFEAT: T = altar_the_shining_one
KFEAT: V = altar_elyvilon
MARKER: E = lua:transp_dest_loc("holy_entry")
MARKER: F = lua:transp_loc("octorealm_entry")

MAP
XXXXXX
XxmEmx
Xxm=mx
X?...?
XA121A
XZ.T.V
X3*F|3
ENDMAP


NAME: sprint_king_octorealm
TAGS: sprint_king_octorealm no_rotate no_hmirror no_vmirror
#KMONS: 1 = octopode tile:tran_statue_octopode ; trident ego:speed
KMONS: 1 = nothing
#KMONS: 2 = octopode tile:tran_lich_octopode god:gozag name:Regal name_replace spells:radiant_gaze.100.natural ; trident randart . crown_of_dyrovepreva
KMONS: 2 = regal band
KMONS: 3 = octopode att:friendly tile:tran_storm_octopode; trident ego:heavy
KMONS: 4 = death cob
KMONS: 5 = killer klown
KFEAT: F12345. = W / w
MARKER: F = lua:transp_dest_loc("octorealm_entry")

MAP
XXXXXXXXXXXXXXXXXX
X......=...=......
X.3333.=...=.1111.
X.3333.=...=.1111.
X.3333.=.4.=.1111.
X.3333.=...=.1111.
X.3333.=...=.1111.
X.3333.=...=.1111.
X.3333.=====.1111.
X.3333.=F=2=.1111.
X.3333.=====.1111.
X.3333.=...=.1111.
X.3333.=...=.1111.
X.3333.=...=.1111.
X.3333.=.5.=.1111.
X.3333.=...=.1111.
X.3333.=...=.1111.
X......=...=......
ENDMAP
